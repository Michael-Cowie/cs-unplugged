{% extends "base.html" %}

{% load i18n %}
{% load static %}
{% load render_html_field %}
{% load django_bootstrap_breadcrumbs %}

{% block title %}
  {{ programming_challenge.name }}
{% endblock title %}

{% block breadcrumbs %}
  {% breadcrumb "Home" "/" %}
  {% breadcrumb "Topics" "topics:index" %}
  {% breadcrumb topic.name "topics:topic" topic.slug %}
  {% breadcrumb programming_challenge.name "topics:programming_challenge" topic.slug programming_challenge.slug %}
{% endblock breadcrumbs %}

{% block page_heading %}
  <h1>
    {{ programming_challenge.name }}
  </h1>
  {% if not programming_challenge.translation_available %}
    {% trans "programming challenge" as programming_challenge_l10n %}
    {% url "topics:topic" topic.slug as parent_url %}
    {% trans "topic" as topic_l10n %}
    {% with model=programming_challenge model_type=programming_challenge_l10n parent=topic parent_type=topic_l10n parent_url=parent_url %}
      {% include 'topics/not-available-warning.html' %}
    {% endwith %}
  {% else %}
    <p class="w-100 text-white rounded p-2 mt-3 difficulty-level-{{ programming_challenge.difficulty.level }}">
      <strong>{% trans "Challenge Level:" %}</strong> {{ programming_challenge.difficulty.name }}
    </p>
  {% endif %}
{% endblock page_heading %}

{% block content_container %}
{% if programming_challenge.translation_available %}
  <div class="col-12 col-md-6">
    {% if lessons %}
      <div class="alert alert-info" role="alert">
        <p>{% trans "This programming challenge is linked to the following lessons:" %}</p>

        <ul class="mb-0">
          {% for lesson in lessons %}
            <li>
              <a href="{% url 'topics:lesson' topic.slug lesson.unit_plan.slug lesson.slug %}">
                {% blocktrans with set_num=lesson.challenge_set_number chal_num=lesson.challenge_number name=lesson.name trimmed %}
                Challenge {{ set_num }}.{{ chal_num }} for {{ name }}
                {% endblocktrans %}
                (
                  {% for age_group in lesson.age_group.all %}
                    {% blocktrans with lower=age_group.ages.lower upper=age_group.ages.upper trimmed %}
                      {{ lower }} to {{ upper }}
                    {% endblocktrans %}
                    {% if not forloop.last %}
                      {% trans "and" %}
                    {% endif %}
                  {% endfor %}
                )
              </a>
              {% if not lesson.translation_available %}
                {% include 'topics/not-available-badge.html' %}
              {% endif %}
            </li>
          {% endfor %}
        </ul>
      </div>
    {% endif %}

    {% if learning_outcomes %}
      <details class="panel-learning-outcomes">
        <summary>
          <strong>{% trans "Learning outcomes" %}</strong>
          <img class="inline-image" src="{% static 'img/general/outcomes.png' %}">
        </summary>
        <div class="boxed-text-content">
          <p>{% trans "Students will be able to:" %}</p>
          <ul>
            {% for learning_outcome in learning_outcomes %}
            <li>
              {{ learning_outcome.text }}<br>
              {% for area in learning_outcome.curriculum_areas.all %}
                {% include "topics/curriculum-area-badge.html" %}
              {% endfor %}
            </li>
            {% endfor %}
          </ul>
        </div>
      </details>
    {% endif %}

    {% render_html_field programming_challenge.content %}
  </div>
  <div class="col-12 col-md-6">
    <h2 class="mt-0">{% trans "Languages" %}</h2>

    {% for implementation in implementations %}
      <details>
        <summary>
          <strong>
            {{ implementation.language.name }}
          </strong>
          {% if not implementation.translation_available %}
            {% include 'topics/not-available-badge.html' %}
          {% endif %}
          <img src="{% get_static_prefix %}{{ implementation.language.icon }}" class="inline-image" />
        </summary>




        <div class="boxed-text-content">
          {% if not implementation.translation_available %}
            {% with model=implementation %}
              {% include 'topics/not-available-warning.html' %}
            {% endwith %}
          {% else %}

                      <!-- MY STUFF !-->
            {% if implementation.language.slug == "python" %}
            <span> Enter your code here </span>
            <div id="codeeditor">

            </div>

            <div style="margin:1em 0; text-align: center"> 

            <button type="submit" class="btn btn-light" style="border: 2px dashed" onclick="sendCode();"> Submit Code </button> 

            </div>
            <!-- TODO: inline css needs to be moved -->
            {% endif %}

                      <!-- END OF MY STUFF -->

    

            <h4>{% trans "What it should look like" %}</h4>
            {% render_html_field implementation.expected_result %}


                          <!-- MY STUFF !-->

            {% if implementation.language.slug == "python" %}

            <div> Your code output! </div>
            <div disabled id="outputBox">
              
            </div>

            <div id="outputImage" style="text-align: center; margin: 1em 0;">

            </div>

            {% endif %}
                          <!-- END OF MY STUFF -->

            


            {% if implementation.hints %}
              <details style="margin: 1em 0;">
                <summary >
                  <strong>
                    {% trans "Hints" %}
                  </strong>
                </summary>

                <div class="boxed-text-content">
                  {% render_html_field implementation.hints %}
                </div>
              </details>
            {% endif %}

          <p class="text-center">
            <a href="{% url 'topics:programming_challenge_solution' topic.slug programming_challenge.slug implementation.language.slug %}">
              {% blocktrans trimmed %}
                Show {{ implementation.language.name }} solution
              {% endblocktrans %}
            </a>
          </p>
          {% endif %}
        </div>
      </details>
    {% endfor %}
  </div>
  {% endif %}



<!-- MY STUFF !-->
    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="http://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>

    <!-- <script src="{% static 'js/python.js' %}"></script> -->

    <script>
    var editor = CodeMirror(document.getElementById("codeeditor"), {
      lineNumbers : true,
      gutter: true,
      lineWrapping: true,
      autoRefresh: true,
      mode: "python"
    });

    var outputBox = CodeMirror(document.getElementById("outputBox"), {
      gutter: true,
      lineWrapping: true,
      readOnly: false,
      cursorBlinkRate: -1,
      mode: "python"
    });


      var base_url = "http://36adab90.compilers.sphere-engine.com/api/v3/submissions/";
      var token = "?access_token=5ec1d247f7d8b651411587faf1af080c";

      function sendCode() {
        $.ajax({
          type: "POST",
          url: base_url + token,
          data: {
            "language": 116,
            "sourceCode": editor.getValue(),
          },
          async: true,
          dataType: "json",
          success: function(result, status){
            id = result.id;
            setTimeout(function(){
              getCodeCompiled(id);
            }, 1000);
          },
          error: function(result, status){
            console.log("Error", result, status)
          }
        });
      };


     function getCodeCompiled(id) {
      $.ajax({
        type: "GET",
        url: base_url + id + token,
        data: {
            "withSource": true,
            "withOutput": true,
        },
        async: true,
        dataType: "json",
        success: function(result, status){
          if (result.status !== 0) {
            setTimeout(function(){
              getCodeCompiled(id);
            }, 1000);
          } else {
            outputBox.getDoc().setValue(result.output);
            if(isCorrectAnswer(result.output)){
                viewCorrectAnswerImage();
              } else {
                viewIncorrectAnswerImage();
              }
          }
        },
        error: function(result, status){
          console.log("Error", result, status)
        }
      });
    };

    function isCorrectAnswer(user_output){
        var x = document.getElementsByClassName('codehilite')[0].innerHTML.substring(18,28) + '\n'; // TODO: CHANGE THIS LATER!
        return user_output === x;

    };

    function viewCorrectAnswerImage(){
      $("#outputImage").html("<img src='{% static 'img/right-answer.png' %}'' class='inline-image' style='max-height: 4rem;' />");
    }

    function viewIncorrectAnswerImage(){
      $("#outputImage").html("<img src='{% static 'img/wrong-answer.png' %}'' class='inline-image' style='max-height: 4rem;' />");
    }


    </script>

{% endblock content_container %}

{% block end_content %}
  {% if programming_challenge.translation_available %}
    {% if programming_challenge.extra_challenge %}
      <h2>{% trans "Extra Challenge" %}</h2>
      {% render_html_field programming_challenge.extra_challenge %}
    {% endif %}
  {% endif %}
{% endblock end_content %}


